{% extends 'NSAdminBundle::layout.html.twig' %}

{% block styles %}
	{{ parent() }}
	<link href="{{ asset('bundles/nscatalog/css/inline-edit.css') }}" type="text/css" rel="stylesheet" media="screen"/>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script type="text/javascript" src="{{ asset('bundles/nscatalog/js/inline-edit.js') }}"></script>
{% endblock %}

{% block content %}
	<h3>Управление товарами</h3>

	<div class="row">
		<div class="span3">
			{{ render(controller('NSCatalogBundle:AdminCategories:categoryTree'))  }}
		</div>
		<div class="span9">
			<div class="navbar">
				<div class="navbar-inner">
					<form class="navbar-search pull-left" method="GET">
						<input type="text" class="search-query" name="search" placeholder="Поиск" value="{{ search }}" />
					</form>

					<a href="#" class="btn pull-right" id="btnAddItem"><i class="icon-plus"></i> Добавить товар</a>
				</div>
			</div>

			{% if pagination.count %}
				<form action="">
					<table class="table table-striped table-hover">
						<thead>
						<tr>
							<th style="width:20px">
								<input type="checkbox" />
							</th>
							{% include 'NSCatalogBundle:AdminCatalog:index-header.html.twig' %}
							<th style="width:70px">&nbsp;</th>
						</tr>
						</thead>
						<tbody>
						{% for item in pagination %}
							<tr>
								<td><input type="checkbox" name="id[]" value="{{ item.id }}" /></td>
								{% include 'NSCatalogBundle:AdminCatalog:index-row.html.twig' %}
								<td>
									<div class="btn-group pull-right">
										<a href="#" class="btn btn-mini btn-edit-item" data-id="{{ item.id }}"><i class="icon-pencil"></i></a>
										<a href="#" class="btn btn-mini btn-delete-item" data-id="{{ item.id }}"><i class="icon-trash"></i></a>
									</div>
								</td>
							</tr>
						{% endfor %}
						</tbody>
					</table>

					<div class="multi-action">
						<i class="icon-th"></i>
						<div class="btn-group">
							<a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
								Выберите действие
								<span class="caret"></span>
							</a>
							<ul class="dropdown-menu">
								<li><a href="#" class="change-category"><i class="icon-share-alt"></i> Перенести в другую категорию</a></li>
								<li><a href="#" class="clone-items"><i class="icon-plus"></i> Скопировать товары</a></li>
								{#<li><a href="#"><i class="icon-trash"></i> Удалить</a></li>#}
							</ul>
						</div>
					</div>
				</form>

				{{ knp_pagination_render(pagination, 'NSAdminBundle:Generic:pagination.html.twig') }}
			{% else %}
				<p>Не найдено ни одного товара</p>
			{% endif %}
		</div>
	</div>

	<div id="dlgItemForm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="dlgItemFormLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="dlgItemFormLabel"></h3>
		</div>
		<div class="modal-body"></div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal" aria-hidden="true">Отменить</button>
			<button class="btn btn-success btn-save">Сохранить</button>
		</div>
	</div>

	<script type="text/javascript">
		(function($){
			var itemForm    = $('#dlgItemForm');
			var modalItemId = null;

			var fnHandleResponse = function(res) {
				if (res.error) {
					throw res.error;
				}
				itemForm.find('.modal-body').html(res);
				itemForm.find('form').submit(function(){
					fnSave();
					return false;
				});
			};

			var fnSave = function(){
				$.ajax({
					'url': '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'form' }) }}' + (modalItemId ? '?id=' + modalItemId : ''),
					'type': 'POST',
					'data': itemForm.find('form').serialize()
				})
				.done(function(res){
					fnHandleResponse(res);
					itemForm.modal('hide');
					location.reload();
				});
			};

			itemForm.find('.btn-save').click(fnSave);

			$('#btnAddItem').click(function(){
				$('#dlgItemFormLabel').text('Добавление товара');
				$.ajax({
					url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'form' }) }}{% if category %}?categoryId={{ category.id }}{% endif %}',
					type: 'GET'
				})
				.done(function(res){
					fnHandleResponse(res);
					modalItemId = null;
					itemForm.modal('show');
				});

				return false;
			});

			$('.btn-edit-item').click(function(){
				$('#dlgItemFormLabel').text('Редактирование товара');
				$.ajax({
					url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'form' }) }}?id=' + $(this).data('id') + '&categoryId={% if category %}{{ category.id }}{% endif %}',
					type: 'GET'
				})
				.done($.proxy(function(res){
					fnHandleResponse(res);
					modalItemId = $(this).data('id');
					itemForm.modal('show');
				}, this));

				return false;
			});

			$('.btn-delete-item').click(function(){
				if (!confirm('Вы уверены?')) {
					return false;
				}
				$.ajax({
					url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'delete' }) }}?id=' + $(this).data('id'),
					type: 'POST'
				})
				.done($.proxy(function(res){
					if (res.error) {
						throw res.error;
					}
					location.reload();
				}, this));

				return false;
			});

		}(jQuery));
	</script>


	<div id="dlgMultiActionForm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="dlgMultiActionLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="dlgMultiActionLabel">Выберите категорию</h3>
		</div>
		<div class="modal-body">
			{{ form_widget(categoryForm) }}
		</div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal" aria-hidden="true">Отменить</button>
			<button class="btn btn-success btn-save">Перенести</button>
		</div>
	</div>
	<script type="text/javascript">
		(function($){
			var panel = $('.multi-action');
			var form = panel.parents('form');
			var fnCheckState = function(){
				if (form.find('td input[type=checkbox]:checked').length) {
					panel.show().animate({ height: 40 });
				}
				else {
					panel.animate({ height: 0 }, function(){
						$(this).hide();
					});
				}
			};
			form.find('th input[type=checkbox]').change(function(){
				form.find('td input[type=checkbox]').attr('checked', !!$(this).attr('checked'));
				fnCheckState();
			});
			form.find('td input[type=checkbox]').change(function(){
				fnCheckState();
				form.find('th input[type=checkbox]').attr('checked', form.find('td input[type=checkbox]:checked').length == form.find('td input[type=checkbox]').length);
			});

			// retrieves items
			var fnGetItems = function(){
				var items = [];
				panel.parents('form').find('td input[type=checkbox]:checked').each(function(){
					items.push($(this).val());
				});
				return items;
			};

			// changing category
			panel.find('.change-category').click(function(){
				$('#dlgMultiActionForm').modal('show');
				return false;
			});
			$('#dlgMultiActionForm').find('.btn-save').click(function(){
				var categoryId = $('#dlgMultiActionForm').find('#category_select').val();
				var items = fnGetItems();
				if (categoryId && items.length) {
					$.ajax({
						url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'updateCategory' }) }}',
						type: 'POST',
						data: {
							categoryId: categoryId,
							id: items.join(',')
						}
					})
					.done($.proxy(function(res){
						location.reload();
					}, this));
				}
			});

			// cloning items
			panel.find('.clone-items').click(function(){
				var items = fnGetItems();
				if (items.length) {
					$.ajax({
						url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'cloneItems' }) }}',
						type: 'POST',
						data: {
							id: items.join(',')
						}
					})
					.done($.proxy(function(res){
						location.reload();
					}, this));
				}

				return false;
			});
		})(jQuery);
	</script>
{% endblock %}
