{% extends 'NSAdminBundle::layout.html.twig' %}

{% block styles %}
	{{ parent() }}
	<link href="{{ asset('bundles/nscatalog/css/inline-edit.css') }}" type="text/css" rel="stylesheet" media="screen"/>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script type="text/javascript" src="{{ asset('bundles/nscatalog/js/inline-edit.js') }}"></script>
{% endblock %}

{% block content %}
	<h3>Управление товарами</h3>

	<div class="row">
		<div class="span3">
			{{ render(controller('NSCatalogBundle:AdminCategories:categoryTree'))  }}
		</div>
		<div class="span9">
			<div class="navbar">
				<div class="navbar-inner">
					<form class="navbar-search pull-left">
						<input type="text" class="search-query" placeholder="Поиск" />
					</form>

					<a href="#" class="btn pull-right" id="btnAddItem"><i class="icon-plus"></i> Добавить товар</a>
				</div>
			</div>

			{% if pagination.count %}
				<form action="">
					<table class="table table-striped table-hover">
						<thead>
						<tr>
							<th style="width:20px">&nbsp;</th>
							{% include 'NSCatalogBundle:AdminCatalog:index-header.html.twig' %}
							<th style="width:70px">&nbsp;</th>
						</tr>
						</thead>
						<tbody>
						{% for item in pagination %}
							<tr>
								<td><input type="checkbox" name="id[]" value="1" /></td>
								{% include 'NSCatalogBundle:AdminCatalog:index-row.html.twig' %}
								<td>
									<div class="btn-group pull-right">
										<a href="#" class="btn btn-mini btn-edit-item" data-id="{{ item.id }}"><i class="icon-pencil"></i></a>
										<a href="#" class="btn btn-mini btn-delete-item" data-id="{{ item.id }}"><i class="icon-trash"></i></a>
									</div>
								</td>
							</tr>
						{% endfor %}
						</tbody>
					</table>
				</form>

				{{ knp_pagination_render(pagination, 'NSAdminBundle:Generic:pagination.html.twig') }}
			{% else %}
				<p>Не найдено ни одного товара</p>
			{% endif %}
		</div>
	</div>

	<div id="dlgItemForm" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="dlgItemFormLabel" aria-hidden="true">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h3 id="dlgItemFormLabel"></h3>
		</div>
		<div class="modal-body"></div>
		<div class="modal-footer">
			<button class="btn" data-dismiss="modal" aria-hidden="true">Отменить</button>
			<button class="btn btn-success btn-save">Сохранить</button>
		</div>
	</div>

	<script type="text/javascript">
		(function($){
			var itemForm    = $('#dlgItemForm');
			var modalItemId = null;

			var fnHandleResponse = function(res) {
				if (res.error) {
					throw res.error;
				}
				itemForm.find('.modal-body').html(res);
				itemForm.find('form').submit(function(){
					fnSave();
					return false;
				});
			};

			var fnSave = function(){
				$.ajax({
					'url': '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'form' }) }}' + (modalItemId ? '?id=' + modalItemId : ''),
					'type': 'POST',
					'data': itemForm.find('form').serialize()
				})
				.done(function(res){
					fnHandleResponse(res);
					itemForm.modal('hide');
					location.reload();
				});
			};

			itemForm.find('.btn-save').click(fnSave);

			$('#btnAddItem').click(function(){
				$('#dlgItemFormLabel').text('Добавление товара');
				$.ajax({
					url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'form' }) }}{% if category %}?categoryId={{ category.id }}{% endif %}',
					type: 'GET'
				})
				.done(function(res){
					fnHandleResponse(res);
					modalItemId = null;
					itemForm.modal('show');
				});

				return false;
			});

			$('.btn-edit-item').click(function(){
				$('#dlgItemFormLabel').text('Редактирование товара');
				$.ajax({
					url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'form' }) }}?id=' + $(this).data('id') + '&categoryId={% if category %}{{ category.id }}{% endif %}',
					type: 'GET'
				})
				.done($.proxy(function(res){
					fnHandleResponse(res);
					modalItemId = $(this).data('id');
					itemForm.modal('show');
				}, this));

				return false;
			});

			$('.btn-delete-item').click(function(){
				if (!confirm('Вы уверены?')) {
					return false;
				}
				$.ajax({
					url:  '{{ url('ns_admin_bundle', { adminBundle: 'NSCatalogBundle', adminController: 'itemsApi', adminAction: 'delete' }) }}?id=' + $(this).data('id'),
					type: 'POST'
				})
				.done($.proxy(function(res){
					if (res.error) {
						throw res.error;
					}
					location.reload();
				}, this));

				return false;
			});

		}(jQuery));
	</script>
{% endblock %}
